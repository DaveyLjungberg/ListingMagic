t off# QuickList - Cursor Rules

You are an expert full-stack developer working on **QuickList**, a SaaS that generates AI-powered real estate listing content in 60-90 seconds.

## Project Overview

**What QuickList Does**: Real estate agents upload property photos → AI generates MLS-compliant descriptions, data extraction, and silent video slideshows.

**Tech Stack**:
- **Frontend**: Next.js 15, React 19, TypeScript, Tailwind CSS (Vercel)
- **Backend**: Python FastAPI (Railway)
- **Database**: Supabase PostgreSQL + Auth + Storage
- **AI**: GPT-4o (primary), Gemini Pro (secondary)

**URLs**:
- Frontend: https://listing-magic.vercel.app
- Backend: https://listingmagic-production.up.railway.app
- Database: https://vbfwcemtkgymygccgffl.supabase.co

## MANDATORY: Real-Time Documentation Updates

**Update docs AS YOU WORK, not at the end of a session.**

When you make changes to QuickList, immediately update:
- **Code changes** → `CLAUDE.md`, `.cursorrules`
- **Bug fixes** → Add to "Known Issues" sections + `.agent-workspace/logs/bugs/`
- **Features** → Update codebase structure, generation flow
- **Tech decisions** → `.agent-workspace/context/tech-decisions.md`

**Rule**: If you changed code, update the docs. No exceptions.

## CRITICAL: Fair Housing Compliance

ALL AI-generated descriptions MUST follow Fair Housing rules:

**PROHIBITED**:
- "Step inside", "Welcome to", "Come see" (imperative language)
- "you", "your", "you'll" (second-person pronouns)
- "Perfect for families", "Ideal for retirees" (buyer-specific)
- "Master bedroom" (use "Primary bedroom")

**REQUIRED**:
- Third-person only: "This residence features..."
- Factual descriptions only
- Objective statements

## Code Structure

```
listing-magic/
├── app/                          # Next.js App Router
│   ├── api/
│   │   ├── credits/              # Credit system API
│   │   │   ├── route.ts          # GET balance, POST use credit
│   │   │   └── add/route.ts      # POST add credits (admin)
│   │   ├── stripe/               # Stripe payment integration
│   │   │   ├── checkout/route.js # POST create credit purchase checkout
│   │   │   └── webhook/route.js  # POST webhook for credit fulfillment
│   │   └── listings/             # Listings CRUD
│   ├── dashboard/
│   │   ├── generate/             # Main generation page
│   │   │   ├── components/       # DescriptionsTab, MLSDataTab, ResultsTabs
│   │   │   ├── hooks/            # useDescriptionsState, useMLSState, useVideoGeneration
│   │   │   └── page.jsx          # Main orchestrator
│   │   └── pricing/              # Credit purchase page
│   │       └── page.jsx          # Pricing cards + team toggle
├── components/
│   └── DashboardHeader.jsx       # Header with "Buy Credits" button
├── libs/
│   ├── generate-api.ts           # Backend API client
│   ├── credits.ts                # Credit system client
│   ├── supabase.js               # Supabase client
│   └── utils.js                  # Utility functions (getDomainFromEmail)
├── python-backend/               # FastAPI backend
│   ├── endpoints/                # API endpoints
│   ├── services/                 # AI provider integrations (openai, gemini)
│   ├── compliance/               # Fair Housing validation
│   └── utils/                    # Prompts, helpers
├── supabase/
│   └── migrations/               # Database migrations
│       └── 001_credit_balances.sql  # Credit system schema + RPC functions
└── .agent-workspace/             # Agent memory (READ THIS FIRST)
```

## Generation Flow (Current)

**IMPORTANT: Credit Gatekeeper** - Credits checked BEFORE generation.

1. **Upload Photos** → Supabase Storage
2. **Name Listing Modal** → Calls `check_and_decrement_credits` RPC
   - Has credits: proceed | No credits: redirect to pricing
3. **Analyze Photos** → GPT-4o Vision (shows "Photo X of Y" progress)
4. **Generate Public Remarks** → GPT-4o (overlay closes when done)
5. **Background Tasks** (sequential):
   - Features List → Gemini
   - Video Generation → FFmpeg (silent slideshow)
   - MLS Extraction → Gemini

**Result Tabs**: Public Remarks | Features Sheet | Video Tour

## Coding Standards

### Frontend Components
```javascript
"use client";  // Only if needed for interactivity

import { useState } from "react";
import { toast } from "react-hot-toast";
import { supabase } from "@/libs/supabase";

const ComponentName = ({ prop }) => {
  const [isLoading, setIsLoading] = useState(false);

  const handleAction = async () => {
    setIsLoading(true);
    try {
      // Action
      toast.success("Success!");
    } catch (error) {
      toast.error(error.message || "Something went wrong");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <button
      onClick={handleAction}
      disabled={isLoading}
      className="btn btn-primary"
    >
      {isLoading ? "Loading..." : "Action"}
    </button>
  );
};

export default ComponentName;
```

### Backend Endpoints
```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel

router = APIRouter()

@router.post("/api/endpoint")
async def endpoint_name(request: RequestModel):
    try:
        # Validation
        if not request.required_field:
            raise HTTPException(status_code=400, detail="Required")

        # Business logic
        result = await service.process(request)

        return {"success": True, "data": result}
    except Exception as e:
        logger.error(f"Error: {e}")
        raise HTTPException(status_code=500, detail="Internal error")
```

## Before Starting Any Task

1. **Read `CLAUDE.md`** - Master instructions
2. **Check `.agent-workspace/context/current-sprint.md`** - What's the focus?
3. **Check `.agent-workspace/logs/bugs/`** - Has this been solved before?
4. **Check `.agent-workspace/knowledge/error-solutions.md`** - Quick fixes

## After Completing Any Task

1. **Bug fixed?** → Add to `.agent-workspace/logs/bugs/`
2. **New pattern?** → Add to `.agent-workspace/knowledge/`
3. **Architecture decision?** → Update `context/tech-decisions.md`

## Key Files Reference

| What | Where |
|------|-------|
| Main generation UI | `app/dashboard/generate/components/DescriptionsTab.jsx` |
| MLS data display | `app/dashboard/generate/components/MLSDataTab.jsx` |
| Credit gatekeeper modal | `components/listing-magic/NameListingModal.jsx` |
| Pricing page | `app/dashboard/pricing/page.jsx` |
| Dashboard header | `components/DashboardHeader.jsx` |
| Backend API client | `libs/generate-api.ts` |
| Credit system client | `libs/credits.ts` |
| Credit API | `app/api/credits/route.ts` |
| Stripe checkout | `app/api/stripe/checkout/route.js` |
| Stripe webhook | `app/api/stripe/webhook/route.js` |
| Utility functions | `libs/utils.js` |
| AI prompts | `python-backend/utils/prompt_templates.py` |
| Fair Housing rules | `python-backend/compliance/fair_housing.py` |
| Agent memory | `.agent-workspace/` |

## Known Issues (Don't Re-Debug)

- ✅ Slow generation → Use GPT-4o not GPT-4.1
- ✅ Timeout → Increased to 300s
- ✅ MLS clearing on switch → Fixed handleLoadDescListing
- ✅ Address lost on tab switch → AddressInput is controlled component
- ✅ Photos not loading → Uses setPhotosFromUrls()
- ✅ Walkthrough complexity → Feature removed (silent videos only)
- ✅ Video not persisting → video_url saved to database, restored on listing load
- ✅ Credit double-charging → Moved to upfront gatekeeper modal (Dec 21, 2025)
- ⚠️ Photo categorization 503 → Non-blocking, low priority
- ⚠️ ATTOM tax data inconsistent → User can manually edit

## Stripe Credit Purchases

QuickList uses Stripe for credit purchases. Credits can be purchased for:
- **Personal**: Tied to user's email (`creditType: "personal"`)
- **Domain**: Shared team pool (`creditType: "domain"`)

**Pricing Tiers** (per-pack):
- Starter: 1 credit for $20
- Pro: 10 credits for $150
- Agency: 50 credits for $400

**Flow**:
1. Frontend → `POST /api/stripe/checkout` with `{priceId, quantity: 1, creditsAmount, creditType, userEmail, successUrl, cancelUrl}`
2. Backend creates Stripe Checkout Session with:
   - Line item quantity = 1 (buy one pack)
   - Metadata: `{targetIdentifier, creditsAmount, creditType}` for fulfillment
3. User completes payment
4. Stripe → `POST /api/stripe/webhook` (checkout.session.completed)
5. Webhook calls Supabase RPC `add_credits(owner, amount)` to increment balance

**Environment Variables** (Required):

Frontend:
- `NEXT_PUBLIC_STRIPE_PRICE_STARTER` - Price ID for 1 credit pack
- `NEXT_PUBLIC_STRIPE_PRICE_PRO` - Price ID for 10 credits pack
- `NEXT_PUBLIC_STRIPE_PRICE_AGENCY` - Price ID for 50 credits pack

Backend/Server:
- `STRIPE_SECRET_KEY` - Stripe API key
- `STRIPE_CREDITS_WEBHOOK_SECRET` - Webhook signing secret (or `STRIPE_WEBHOOK_SECRET`)
- `SUPABASE_SERVICE_ROLE_KEY` - For RPC calls
- `NEXT_PUBLIC_SUPABASE_URL` - Supabase project URL
- `NEXT_PUBLIC_SITE_URL` - For URL validation

**Important**: Stripe Prices must be configured as per-pack prices (not per-credit). Frontend always sends `quantity: 1` to Stripe; the `creditsAmount` field determines how many credits are granted via webhook.

**Note**: Credits webhook (`/api/stripe/webhook`) is separate from legacy subscription webhook (`/api/webhook/stripe`).

## Environment

- Use Plan Mode for complex tasks
- Check existing hooks before creating new ones
- Use absolute imports with `@/` prefix
- Always handle loading states and errors
- Include proper TypeScript types
